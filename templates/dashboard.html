{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-lg mt-4">
  <h1 class="text-start mb-4">Managed Devices</h1>
  
  <!-- Statistics Section -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card  bg-primary mb-3">
        <div class="card-header">Total Devices</div>
        <div class="card-body">
          <h5 class="card-title text-white">{{ total_devices }}</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card  bg-success mb-3">
        <div class="card-header">Active Devices</div>
        <div class="card-body">
          <h5 class="card-title text-white">{{ active_devices }}</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card  bg-danger mb-3">
        <div class="card-header">Offline Devices</div>
        <div class="card-body">
          <h5 class="card-title text-white">{{ offline_devices }}</h5>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card  bg-warning mb-3">
        <div class="card-header">Devices with Issues</div>
        <div class="card-body">
          <h5 class="card-title text-white">{{ devices_with_issues }}</h5>
        </div>
      </div>
    </div>
  </div>

  <!-- Managed Devices Section -->
  <div class="row row-cols-1 row-cols-md-2 g-3">
    {% for device in devices %}
    <div class="col mb-2">
      <div class="card border border-5 border-top-0 border-right-0 border-bottom-0 border-primary rounded-3 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <h5 class="card-title   text-uppercase fs-5">{{ device.username }} ({{ device.vendor }})</h5>
              <p class="card-text text-muted">IP: {{ device.ip }}</p>
            </div>
            <div class="d-flex align-items-center">
              <a href="{% url 'modify_device_connection' pk=device.pk %}" class="btn btn-outline-primary ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Modify Connection">
                <i class="fas fa-cog"></i>
              </a>
              <a href="{% url 'configure_device' pk=device.pk %}" class="btn btn-outline-primary ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Configure Device">
                <i class="fas fa-tools"></i>
              </a>
              <a href="{% url 'view_configurations' pk=device.pk %}" class="btn btn-outline-primary ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="View Configurations">
                <i class="fas fa-file-alt"></i>
              </a>
              <a href="{% url 'schedule_backup' pk=device.pk %}" class="btn btn-outline-primary ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Backup Configuration">
                <i class="fas fa-database"></i>
              </a>
              <form method="post" action="{% url 'rollback_configuration' device.pk %}" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-secondary ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Rollback Configuration">
                  <i class="fas fa-undo-alt"></i>
                </button>
              </form>
              <form id="deleteForm{{ device.pk }}" action="{% url 'delete_device' pk=device.pk %}" method="post" class="d-inline ml-2">
                {% csrf_token %}
                <button type="button" class="btn btn-outline-danger ml-2" data-bs-toggle="tooltip" data-bs-placement="top" title="Delete Device" data-toggle="modal" data-target="#deleteDeviceModal" data-device-id="{{ device.pk }}">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- Chart Section -->
  <div class="mt-5">
    <h2>Configuration Statistics</h2>
    <canvas id="configChart" width="400" height="200"></canvas>
  </div>
</div>

<script>

  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
      var ctx = document.getElementById('configChart').getContext('2d');
      var configChart = new Chart(ctx, {
          type: 'bar',
          data: {
              labels: {{ device_names|safe }},
              datasets: [{
                  label: 'Number of Configurations',
                  data: {{ config_data|safe }},
                  backgroundColor: 'rgba(75, 192, 192, 0.2)',
                  borderColor: 'rgba(75, 192, 192, 1)',
                  borderWidth: 2
              }]
          },
          options: {
              scales: {
              
                  y: {
                      beginAtZero: true,
                  }
              }
          }
      });
  });
</script>
{% endblock content %}
